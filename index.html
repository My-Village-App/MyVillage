<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∞Æ‡∞® ‡∞ä‡∞∞‡∞ø ‡∞∏‡±á‡∞µ‡∞≤‡±Å (Mana Oori Sevalu)</title>
    <meta name="description" content="Local Workers Directory with Ads functionality.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ramabhadra&family=Outfit:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .telugu-font { font-family: 'Ramabhadra', sans-serif; }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .glass-dark { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 50px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-size: 14px; display: flex; align-items: center; gap: 10px; opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success i { color: #4ade80; }
        .toast.error i { color: #f87171; }
    </style>
</head>
<body class="text-slate-800 bg-slate-50 antialiased selection:bg-yellow-200 selection:text-slate-900">

<div class="glass-dark text-white p-4 sticky top-0 z-50 shadow-lg border-b border-slate-700/50">
    <div class="max-w-3xl mx-auto flex justify-between items-center">
        <h1 class="text-lg font-bold tracking-wide flex items-center gap-2">
            <i class="fas fa-location-dot text-[#FFD700] animate-bounce"></i> 
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-300">‡∞Æ‡∞® ‡∞ä‡∞∞‡∞ø ‡∞∏‡±á‡∞µ‡∞≤‡±Å</span>
        </h1>
        <div class="flex items-center gap-3">
            <button id="authBtn" onclick="handleAuthAction()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-sm active:scale-95 transition border border-white/10 backdrop-blur-md">Login</button>
        </div>
    </div>
</div>

<div class="max-w-3xl mx-auto p-4 pb-24">
    
    <div class="relative w-full h-44 bg-slate-800 rounded-2xl overflow-hidden shadow-xl mb-6 group ring-1 ring-slate-900/5">
        <img id="adImage" src="https://via.placeholder.com/800x400/1e293b/FFD700?text=Loading+Ads..." class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 cursor-pointer">
        <div class="absolute top-3 right-3 bg-black/60 text-[#FFD700] text-[10px] px-2 py-0.5 rounded backdrop-blur-md font-bold tracking-wider border border-[#FFD700]/20">AD</div>
        
        <button id="editAdsBtn" onclick="openAdManager()" class="hidden absolute top-3 left-3 bg-white/90 text-slate-900 px-3 py-1.5 rounded-full text-xs font-bold shadow-lg z-20 hover:bg-white active:scale-95 transition">
            <i class="fas fa-chart-line text-blue-600"></i> Manage
        </button>
        
        <div class="absolute bottom-3 left-0 right-0 flex justify-center gap-1.5 z-10" id="adDots"></div>
    </div>

    <div class="flex justify-between items-center mb-5">
        <p class="text-xs text-slate-500 font-medium flex items-center gap-1.5 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">
            <i class="fas fa-shield-alt text-green-500"></i> Verified Services
        </p>
        <button onclick="checkAuthAndAdd()" class="bg-slate-900 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow-lg shadow-blue-900/20 hover:bg-slate-800 active:scale-95 transition flex items-center gap-2 border border-[#FFD700]/30 group">
            <i class="fas fa-plus text-[#FFD700] group-hover:rotate-90 transition duration-300"></i> Add Your Service
        </button>
    </div>

    <div class="sticky top-[72px] z-40 space-y-3 mb-6 transition-all duration-300" id="searchContainer">
        <div class="relative shadow-sm">
            <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
            <input type="text" id="searchInput" onkeyup="filterWorkers()" placeholder="Search (e.g., Auto, Painter)..." class="w-full pl-11 pr-4 py-3 rounded-2xl border-none bg-white shadow-md focus:ring-2 focus:ring-[#FFD700] placeholder-slate-400 text-slate-700 transition-shadow">
        </div>
        
        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="categoryChips">
            <button onclick="filterByChip('')" class="chip active bg-slate-800 text-white px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition">All</button>
            <button onclick="filterByChip('Auto')" class="chip bg-white text-slate-600 border border-slate-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm hover:bg-slate-50 transition">üõ∫ Auto</button>
            <button onclick="filterByChip('Electrician')" class="chip bg-white text-slate-600 border border-slate-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm hover:bg-slate-50 transition">üí° Electrician</button>
            <button onclick="filterByChip('Plumber')" class="chip bg-white text-slate-600 border border-slate-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm hover:bg-slate-50 transition">üîß Plumber</button>
            <button onclick="filterByChip('Driver')" class="chip bg-white text-slate-600 border border-slate-200 px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm hover:bg-slate-50 transition">üöó Driver</button>
        </div>
    </div>

    <div id="loader" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        </div>
    
    <div id="workersList" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pb-10"></div>
    
    <div id="noDataMsg" class="hidden flex flex-col items-center justify-center py-16 text-slate-400">
        <i class="fas fa-search text-4xl mb-3 opacity-20"></i>
        <p>No workers found.</p>
    </div>

</div>

<div id="toast-container"></div>

<div id="adManagerModal" class="hidden fixed inset-0 bg-slate-900/60 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
    <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-md relative max-h-[90vh] overflow-y-auto transform transition-all scale-100">
        <button onclick="document.getElementById('adManagerModal').classList.add('hidden')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
        <h2 class="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2">
            <i class="fas fa-bullhorn text-blue-600"></i> Ad Manager
        </h2>
        
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-2xl mb-6 border border-blue-100 flex justify-between items-center">
            <div>
                <p class="text-xs text-blue-500 font-bold uppercase tracking-wider">Total Clicks</p>
                <h3 id="totalAdClicks" class="text-3xl font-black text-slate-900 mt-1">0</h3>
            </div>
            <div class="bg-white p-2 rounded-xl shadow-sm"><i class="fas fa-chart-bar text-2xl text-blue-500"></i></div>
        </div>

        <div id="adminAdsList" class="space-y-3 mb-6 max-h-48 overflow-y-auto p-1 custom-scroll"></div>

        <div class="border-t border-dashed border-slate-200 pt-4">
            <h3 class="text-sm font-bold text-slate-700 mb-3">Add New Banner</h3>
            <div class="space-y-3">
                <label class="block w-full h-24 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 hover:border-blue-400 transition group">
                    <i class="fas fa-cloud-upload-alt text-slate-400 text-2xl group-hover:scale-110 transition"></i>
                    <span class="text-xs text-slate-500 mt-1 font-medium">Select Image (Landscape)</span>
                    <input type="file" accept="image/*" class="hidden" onchange="previewAdImage(this)">
                </label>
                
                <div id="adPreviewBox" class="hidden w-full h-32 bg-slate-100 rounded-xl overflow-hidden relative shadow-md ring-2 ring-blue-100">
                    <img id="newAdImgPreview" class="w-full h-full object-cover">
                    <button onclick="clearAdPreview()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs backdrop-blur-sm"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex gap-2">
                    <select id="adType" class="p-3 border-none bg-slate-100 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-blue-500 w-1/3">
                        <option value="tel:">Phone</option>
                        <option value="https://wa.me/91">WhatsApp</option>
                    </select>
                    <input type="tel" id="adNumber" placeholder="Number (No spaces)" class="p-3 border-none bg-slate-100 rounded-xl text-sm w-2/3 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="saveNewAd()" id="saveAdBtn" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold shadow-lg shadow-slate-900/20 hover:bg-slate-800 transition transform active:scale-[0.98]">Publish Ad</button>
            </div>
        </div>
    </div>
</div>

<div id="addForm" class="hidden fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
    <div class="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-md relative max-h-[85vh] overflow-y-auto slide-up">
        <button onclick="toggleForm()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-6 text-slate-800"><span id="formTitle">Add Service</span></h2>
        
        <form id="workerForm" class="space-y-4">
            <div class="flex justify-center mb-6">
                <label class="cursor-pointer relative group">
                    <div id="photoPreview" class="w-24 h-24 rounded-full bg-slate-50 border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden group-hover:border-[#FFD700] transition shadow-inner">
                        <i class="fas fa-camera text-slate-300 text-3xl group-hover:text-[#FFD700] transition"></i>
                    </div>
                    <div class="absolute bottom-0 right-0 bg-[#FFD700] text-blue-900 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transform translate-x-1 translate-y-1"><i class="fas fa-plus text-xs"></i></div>
                    <input type="file" id="wPhotoInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                </label>
            </div>
            
            <div class="space-y-3">
                <input type="text" id="wName" placeholder="Your Name" class="w-full p-3.5 bg-slate-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-[#FFD700] transition font-medium" required>
                <input type="text" id="wJob" placeholder="Service (e.g., Auto Driver)" class="w-full p-3.5 bg-slate-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-[#FFD700] transition font-medium" required>
                <input type="text" id="wArea" placeholder="Area / Village" class="w-full p-3.5 bg-slate-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-[#FFD700] transition font-medium">
                <input type="tel" id="wPhone" placeholder="Mobile Number" class="w-full p-3.5 bg-slate-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-[#FFD700] transition font-medium" required>
                <textarea id="wBio" rows="2" placeholder="Extra details (Timings, Specialization)..." class="w-full p-3.5 bg-slate-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-[#FFD700] transition font-medium"></textarea>
            </div>

            <button type="button" id="deleteEntryBtn" onclick="deleteMyEntry()" class="hidden w-full text-red-500 py-2 text-sm font-bold hover:bg-red-50 rounded-xl transition">Delete My Entry</button>
            <button type="submit" id="submitBtn" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition transform active:scale-[0.98]">Save Details</button>
        </form>
    </div>
</div>

<div id="profileModal" class="hidden fixed inset-0 bg-slate-900/80 z-[70] flex items-end sm:items-center justify-center fade-in backdrop-blur-md">
    <div class="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-hidden relative max-h-[90vh] overflow-y-auto flex flex-col slide-up">
        
        <div class="bg-slate-900 h-32 relative">
             <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent"></div>
             <button onclick="closeProfile()" class="absolute top-4 right-4 bg-black/20 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-md hover:bg-black/40 transition z-10"><i class="fas fa-times"></i></button>
             <div id="ownerControls" class="absolute top-4 left-4 z-10"></div>
        </div>

        <div class="px-6 pb-6 -mt-12 relative flex-1 overflow-y-auto">
            <div id="pIconContainer" class="w-24 h-24 rounded-full bg-white p-1 shadow-xl flex items-center justify-center overflow-hidden border border-slate-100 mx-auto relative z-10"></div>
            
            <div class="text-center mt-3">
                <h2 id="pName" class="text-2xl font-bold text-slate-800 tracking-tight">Name</h2>
                <p id="pJob" class="text-[#b45309] bg-yellow-100 inline-block px-3 py-0.5 rounded-full text-xs font-bold uppercase tracking-wider mt-1 mb-2">Job</p>
                
                <div class="flex justify-center items-center gap-1.5 bg-slate-100 py-1.5 px-4 rounded-full mx-auto w-max shadow-inner">
                    <span id="pAvgRating" class="font-bold text-slate-700">0.0</span> 
                    <i class="fas fa-star text-[#FFD700]"></i> 
                    <span id="pReviewCount" class="text-slate-400 text-xs font-medium">(0 Reviews)</span>
                </div>
            </div>

            <div class="mt-6 space-y-5">
                <div class="bg-slate-50 p-4 rounded-2xl text-sm text-slate-600 border border-slate-100 leading-relaxed relative" id="pBioContainer">
                    <i class="fas fa-quote-left text-slate-200 text-2xl absolute -top-2 -left-1"></i>
                    <p id="pBio" class="relative z-10 pl-2">...</p>
                </div>
                
                <a id="pCallBtn" href="#" class="block w-full bg-green-500 text-white text-center py-3.5 rounded-xl font-bold shadow-lg shadow-green-500/30 hover:bg-green-600 transition transform active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fas fa-phone-alt animate-pulse"></i> Call Now
                </a>

                <div class="border-t border-slate-100 pt-5">
                    <h3 class="font-bold mb-3 text-slate-800 flex items-center gap-2 text-sm uppercase tracking-wide">
                        <i class="fas fa-comments text-slate-300"></i> Reviews
                    </h3>
                    
                    <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-4">
                        <p class="text-xs text-slate-400 mb-2 font-bold uppercase text-center">Rate this service</p>
                        <div class="flex gap-3 text-3xl text-slate-200 justify-center mb-4 transition-all" id="starInput">
                            <button onclick="setRating(1)" class="star-btn hover:text-[#FFD700] hover:scale-110"><i class="fas fa-star"></i></button>
                            <button onclick="setRating(2)" class="star-btn hover:text-[#FFD700] hover:scale-110"><i class="fas fa-star"></i></button>
                            <button onclick="setRating(3)" class="star-btn hover:text-[#FFD700] hover:scale-110"><i class="fas fa-star"></i></button>
                            <button onclick="setRating(4)" class="star-btn hover:text-[#FFD700] hover:scale-110"><i class="fas fa-star"></i></button>
                            <button onclick="setRating(5)" class="star-btn hover:text-[#FFD700] hover:scale-110"><i class="fas fa-star"></i></button>
                        </div>
                        <input type="hidden" id="editReviewIndex" value="-1">
                        <div class="relative">
                            <textarea id="reviewText" placeholder="Share your experience..." class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm mb-2 focus:ring-2 focus:ring-[#FFD700] outline-none resize-none"></textarea>
                            <button onclick="submitReview()" id="postReviewBtn" class="absolute bottom-4 right-2 bg-slate-900 text-white px-3 py-1 rounded-lg text-xs font-bold shadow hover:bg-slate-700">Post</button>
                        </div>
                        <button onclick="cancelEdit()" id="cancelEditBtn" class="hidden w-full text-slate-400 text-xs mt-1 hover:text-red-500 transition">Cancel Edit</button>
                    </div>

                    <div id="commentsList" class="space-y-3 pb-4"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, getDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    // CONFIG (SAME AS YOURS)
    const firebaseConfig = {    
      apiKey: "AIzaSyBfonEUIssxYV5BFxOEsTIA9alYzISEOGU",    
      authDomain: "myvillage-app-c3550.firebaseapp.com",    
      projectId: "myvillage-app-c3550",    
      storageBucket: "myvillage-app-c3550.firebasestorage.app",    
      messagingSenderId: "1081682544474",    
      appId: "1:1081682544474:web:c844c928e69915013b1563",    
      measurementId: "G-6Q5425DBFS"    
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "josephyesebu37@gmail.com";
  
    let currentUser = null, allWorkers = [], allAds = [], editingId = null, currentRating = 0, openProfileId = null, currentPhotoBase64 = null, newAdBase64 = null;
  
    // --- üîî UX ENHANCEMENTS: TOASTS & SKELETONS üîî ---
    window.showToast = (msg, type = 'success') => {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        el.className = `toast ${type}`;
        el.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
        container.appendChild(el);
        setTimeout(() => el.classList.add('show'), 10);
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 3000);
    };

    function showSkeleton() {
        const list = document.getElementById('loader');
        list.classList.remove('hidden');
        list.innerHTML = Array(4).fill(0).map(() => `
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-3">
                <div class="w-12 h-12 rounded-full skeleton shrink-0"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-slate-100 rounded w-3/4 skeleton"></div>
                    <div class="h-3 bg-slate-100 rounded w-1/2 skeleton"></div>
                </div>
            </div>
        `).join('');
    }
    showSkeleton(); // Init

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
        const btn = document.getElementById('authBtn');
        if (user) {
            currentUser = user;
            btn.innerText = "Logout";
            if(user.email === ADMIN_EMAIL) document.getElementById('editAdsBtn').classList.remove('hidden');
        } else {
            currentUser = null;
            btn.innerText = "Login";
            document.getElementById('editAdsBtn').classList.add('hidden');
        }
    });
  
    window.handleAuthAction = () => { currentUser ? (confirm("Logout?") && signOut(auth).then(()=>showToast("Logged Out"))) : signInWithPopup(auth, provider).then(()=>showToast("Welcome Back!")).catch(e => showToast(e.message, 'error')); }
  
    // --- ADS ---
    const adsRef = collection(db, "banners");
    onSnapshot(adsRef, (s) => {     
        allAds = s.docs.map(d => ({ id: d.id, ...d.data() }));     
        initAdsDisplay();     
        if(!document.getElementById('adManagerModal').classList.contains('hidden')) renderAdminAdsList();     
    });
    
    let currentAdIndex = 0;
    const adImage = document.getElementById('adImage');
    const adDots = document.getElementById('adDots');
  
    function initAdsDisplay() {
        if(allAds.length === 0) {     
            adImage.src = "https://via.placeholder.com/800x400/1e293b/FFD700?text=Advertise+Here";     
            adDots.innerHTML = "";     
            adImage.onclick = null;    
            return;     
        }    
        adDots.innerHTML = allAds.map((_, i) => `<div class="w-1.5 h-1.5 rounded-full transition-all duration-300 ${i===0?'bg-[#FFD700] w-4':'bg-white/50'}"></div>`).join('');    
        showAd(0);    
    }
  
    function showAd(index) {    
        if(allAds.length === 0) return;
        adImage.style.opacity = '0'; // Smooth fade
        setTimeout(() => {    
            adImage.src = allAds[index].img;
            adImage.style.opacity = '1';    
            Array.from(adDots.children).forEach((dot, i) => dot.className = `w-1.5 h-1.5 rounded-full transition-all duration-300 ${i===index?'bg-[#FFD700] w-4':'bg-white/50'}`);    
            adImage.onclick = () => trackAdClick(allAds[index].id, allAds[index].link);    
        }, 300);    
    }
    setInterval(() => { if(allAds.length > 1) { currentAdIndex = (currentAdIndex + 1) % allAds.length; showAd(currentAdIndex); } }, 5000);
    
    window.trackAdClick = async (adId, link) => {    
        if(!link || link === "#") return;    
        window.location.href = link;    
        try { await updateDoc(doc(db, "banners", adId), { clicks: increment(1) }); } catch(e) {}    
    }

    // --- ADMIN ---
    window.openAdManager = () => { if(prompt("üîê Password:") === "admin123") { document.getElementById('adManagerModal').classList.remove('hidden'); renderAdminAdsList(); } else showToast("Wrong Password", "error"); }
    window.clearAdPreview = () => { newAdBase64=null; document.getElementById('adPreviewBox').classList.add('hidden'); document.getElementById('newAdImgPreview').src=""; }
    
    function renderAdminAdsList() {
        const list = document.getElementById('adminAdsList');
        let totalClicks = allAds.reduce((sum, ad) => sum + (ad.clicks || 0), 0);
        document.getElementById('totalAdClicks').innerText = totalClicks;
        list.innerHTML = allAds.map(ad => `
            <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-lg border border-slate-100">
                <img src="${ad.img}" class="w-14 h-8 object-cover rounded bg-slate-200">
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] text-slate-400 font-mono truncate">${ad.link}</p>
                    <p class="text-xs font-bold text-blue-600">${ad.clicks || 0} Clicks</p>
                </div>
                <button onclick="deleteAd('${ad.id}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition"><i class="fas fa-trash"></i></button>
            </div>
        `).join('') || `<p class="text-xs text-slate-400 text-center py-4">No ads running.</p>`;
    }
    
    window.previewAdImage = (i) => { previewImageLogic(i, 'ad'); }

    window.saveNewAd = async () => {    
        if(!newAdBase64) return showToast("Image required", "error");
        const btn = document.getElementById('saveAdBtn'); btn.innerText="Publishing..."; btn.disabled=true;    
        try {     
            await addDoc(collection(db, "banners"), { img: newAdBase64, link: document.getElementById('adType').value + document.getElementById('adNumber').value, clicks: 0, createdAt: new Date().toISOString() });     
            clearAdPreview(); document.getElementById('adNumber').value=""; showToast("Ad Published!");     
        } catch(e){showToast(e.message, 'error')} finally{btn.innerText="Publish Ad"; btn.disabled=false;}    
    }    
    window.deleteAd = async(id) => { if(confirm("Stop this Ad?")) await deleteDoc(doc(db, "banners", id)); }

    // --- WORKERS DATA ---
    const q = collection(db, "workers");
    onSnapshot(q, (s) => {    
        allWorkers = s.docs.map(d => ({ id: d.id, ...d.data() }));    
        allWorkers.sort((a, b) => (a.name || "").localeCompare(b.name || ""));    
        renderWorkers(allWorkers);    
        document.getElementById('loader').classList.add('hidden');
        if(openProfileId) { const w = allWorkers.find(x => x.id === openProfileId); if(w) openProfile(w.id, true); }    
    });

    function renderWorkers(data) {    
        const list = document.getElementById('workersList');    
        list.innerHTML = "";    
        document.getElementById('noDataMsg').classList.toggle('hidden', data.length > 0);
        
        // Staggered Animation Delay
        data.forEach((worker, index) => {    
            const style = getIconByJob(worker.job);    
            const rating = worker.ratingCount > 0 ? (worker.totalStars / worker.ratingCount).toFixed(1) : "New";
            const delay = index < 10 ? index * 50 : 0;
            
            let avatarHtml = worker.photo ? `<img src="${worker.photo}" class="w-full h-full object-cover">` : `<i class="fas ${style.icon} text-xl"></i>`;
            let avatarClass = worker.photo ? "" : style.color; // If no photo, use color bg

            const html = `    
                <div class="glass p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 relative group active:scale-[0.98] transition-all cursor-pointer overflow-hidden slide-up hover:shadow-md"
                     style="animation-delay: ${delay}ms"
                     onclick="openProfile('${worker.id}')"
                >    
                    <div class="w-14 h-14 rounded-full ${worker.photo ? 'bg-slate-100' : style.color} flex items-center justify-center shrink-0 overflow-hidden shadow-inner border border-slate-50">
                        ${avatarHtml}
                    </div>
                    <div class="flex-1 min-w-0">    
                        <h3 class="font-bold text-slate-800 text-base truncate capitalize">${worker.name}</h3>    
                        <p class="text-xs text-[#b45309] font-bold truncate mb-1 uppercase tracking-wide opacity-80">${worker.job}</p>    
                        <div class="flex items-center gap-2 text-[11px] text-slate-500 font-medium">    
                            <span class="bg-yellow-50 text-yellow-700 px-1.5 py-0.5 rounded flex items-center border border-yellow-100"><i class="fas fa-star text-[9px] mr-1 text-[#FFD700]"></i>${rating}</span>    
                            <span class="truncate"><i class="fas fa-map-marker-alt mr-1 opacity-50"></i>${worker.area || 'Local'}</span>    
                        </div>    
                    </div>    
                    <div class="w-8 h-8 rounded-full bg-slate-50 text-slate-300 flex items-center justify-center group-hover:bg-[#FFD700] group-hover:text-blue-900 transition"><i class="fas fa-chevron-right text-xs"></i></div>
                </div>    
            `;    
            list.innerHTML += html;    
        });    
    }

    // --- FILTER CHIPS ---
    window.filterByChip = (category) => {
        document.getElementById('searchInput').value = category;
        document.querySelectorAll('.chip').forEach(c => {
            if(c.innerText.includes(category) && category !== '') {
                c.classList.add('bg-slate-800', 'text-white'); c.classList.remove('bg-white', 'text-slate-600');
            } else if (category === '' && c.innerText === 'All') {
                 c.classList.add('bg-slate-800', 'text-white');
            } else {
                c.classList.remove('bg-slate-800', 'text-white'); c.classList.add('bg-white', 'text-slate-600');
            }
        });
        filterWorkers();
    }

    // --- PROFILE ---
    window.openProfile = (id, isRefresh=false) => {    
        const w = allWorkers.find(x => x.id === id); if(!w) return; openProfileId = id;    
        document.getElementById('pName').innerText = w.name;    
        document.getElementById('pJob').innerText = w.job;    
        document.getElementById('pBio').innerText = w.bio || "No additional details provided.";    
        document.getElementById('pCallBtn').href = `tel:${w.phone}`;    
        const ic = document.getElementById('pIconContainer');    
        if(w.photo) ic.innerHTML=`<img src="${w.photo}" class="w-full h-full object-cover">`;    
        else { const s=getIconByJob(w.job); ic.innerHTML=`<div class="w-full h-full ${s.color} flex items-center justify-center text-3xl"><i class="fas ${s.icon}"></i></div>`; }    
            
        const avg = w.ratingCount > 0 ? (w.totalStars / w.ratingCount).toFixed(1) : "0.0";    
        document.getElementById('pAvgRating').innerText = avg;    
        document.getElementById('pReviewCount').innerText = `(${w.ratingCount||0} Reviews)`;    
            
        const ownerDiv = document.getElementById('ownerControls');    
        ownerDiv.innerHTML = "";     
        if (currentUser && (currentUser.uid === w.addedByUid || currentUser.email === ADMIN_EMAIL)) {    
            ownerDiv.innerHTML = `<button onclick="handleEditWorker('${w.id}')" class="bg-white/20 text-white backdrop-blur-md px-3 py-1.5 rounded-full text-xs font-bold hover:bg-white/30 transition shadow-lg"><i class="fas fa-edit"></i> Edit</button>`;    
        }
        
        // Hide review box if already rated
        const hasRated = currentUser && w.reviews?.some(r => r.uid === currentUser.uid && r.rating > 0);
        document.getElementById('starInput').classList.toggle('opacity-50', hasRated);
        document.getElementById('starInput').classList.toggle('pointer-events-none', hasRated);

        renderComments(w.reviews);
        if(!isRefresh) document.getElementById('profileModal').classList.remove('hidden');    
    }

    function renderComments(reviews) {
        const cList = document.getElementById('commentsList'); cList.innerHTML = '';    
        if(reviews?.length) {    
            reviews.slice().reverse().forEach((r, i) => {    
                if(r.comment?.trim()) {    
                    const isMe = currentUser && r.uid === currentUser.uid;    
                    const editBtn = isMe ? `<button onclick="editReview(${reviews.length - 1 - i})" class="text-blue-500 ml-2 text-[10px] font-bold">Edit</button>` : '';    
                    let dName = isMe ? "You" : (r.user || "User");    
                    // Generate stars for review
                    let stars = Array(5).fill(0).map((_,si) => `<i class="fas fa-star text-[8px] ${si<r.rating?'text-[#FFD700]':'text-slate-200'}"></i>`).join('');
                    
                    cList.innerHTML += `
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-sm mb-2">
                            <div class="flex justify-between items-start mb-1">
                                <p class="font-bold text-xs text-slate-700">${dName} ${editBtn}</p>
                                <div class="flex">${stars}</div>
                            </div>
                            <p class="text-slate-600 leading-snug text-xs">${r.comment}</p>
                        </div>`;    
                }    
            });    
        } else cList.innerHTML = '<div class="text-center py-4 bg-slate-50 rounded-xl border border-dashed border-slate-200"><p class="text-xs text-slate-400">No reviews yet. Be the first!</p></div>';
    }

    // --- REVIEWS LOGIC ---
    window.setRating = (n) => { currentRating = n; updateStars(n); }    
    function updateStars(n) { document.querySelectorAll('#starInput button').forEach((b,i) => { b.classList.toggle('text-[#FFD700]', i<n); b.classList.toggle('scale-110', i<n); }); }    
        
    window.submitReview = async () => {    
        if(!currentUser) return showToast("Login to Review", "error");    
        const txt = document.getElementById('reviewText').value.trim();    
        const idx = parseInt(document.getElementById('editReviewIndex').value);    
        if(!txt && currentRating===0) return showToast("Please write or rate", "error");
        
        const btn = document.getElementById('postReviewBtn'); btn.innerText="..."; btn.disabled=true;    
        try {    
            const ref = doc(db, "workers", openProfileId);    
            const w = allWorkers.find(x => x.id === openProfileId);    
            let revs = w.reviews || [];    
            if(idx > -1) revs[idx].comment = txt; // Simple edit logic (rating locked for now to keep simple)
            else {    
                if(currentRating>0 && revs.some(r=>r.uid===currentUser.uid && r.rating>0)) { showToast("You already rated!"); currentRating=0; }    
                revs.push({ uid:currentUser.uid, user:currentUser.displayName, rating:currentRating, comment:txt, date:new Date().toISOString() });    
            }    
            let s=0, c=0; revs.forEach(r => { if(r.rating>0){ s+=r.rating; c++; } });    
            await updateDoc(ref, { reviews: revs, totalStars: s, ratingCount: c });    
            cancelEdit(); showToast("Review Posted!");    
        } catch(e){showToast(e.message, 'error')} finally{btn.innerText="Post"; btn.disabled=false;}    
    }
    
    window.editReview = (idx) => {    
        const w = allWorkers.find(x => x.id === openProfileId);    
        document.getElementById('reviewText').value = w.reviews[idx].comment;    
        document.getElementById('editReviewIndex').value = idx;    
        document.getElementById('postReviewBtn').innerText = "Update";    
        document.getElementById('cancelEditBtn').classList.remove('hidden');    
    }    
    window.cancelEdit = () => { document.getElementById('reviewText').value=""; document.getElementById('editReviewIndex').value=-1; document.getElementById('postReviewBtn').innerText="Post"; document.getElementById('cancelEditBtn').classList.add('hidden'); currentRating=0; updateStars(0); }

    // --- IMAGE & FORM ---
    window.previewImage = (input) => { previewImageLogic(input, 'worker'); }

    function previewImageLogic(input, type) {
        if(input.files && input.files[0]) {    
            const r = new FileReader();    
            r.onload = (e) => {    
                const i = new Image(); i.src = e.target.result;    
                i.onload = () => {    
                    const c = document.createElement('canvas');    
                    const s = 800/i.width; c.width=800; c.height=i.height*s;    
                    c.getContext('2d').drawImage(i,0,0,c.width,c.height);    
                    const b64 = c.toDataURL('image/jpeg', 0.7);
                    
                    if(type === 'worker') {
                        currentPhotoBase64 = b64;
                        document.getElementById('photoPreview').innerHTML = `<img src="${b64}" class="w-full h-full object-cover">`;
                    } else {
                        newAdBase64 = b64;
                        document.getElementById('newAdImgPreview').src = b64;
                        document.getElementById('adPreviewBox').classList.remove('hidden');
                    }    
                }    
            };    
            r.readAsDataURL(input.files[0]);    
        }
    }

    window.checkAuthAndAdd = async () => {    
        if(!currentUser) return showToast("Please Login First", "error");    
        const btn = document.querySelector('button[onclick="checkAuthAndAdd()"]'); 
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        try {    
            const q = query(collection(db, "workers"), where("addedByUid", "==", currentUser.uid));    
            const snap = await getDocs(q);    
            editingId=null; document.getElementById('workerForm').reset();     
            document.getElementById('formTitle').innerText="Add Service";     
            document.getElementById('photoPreview').innerHTML=`<i class="fas fa-camera text-slate-300 text-3xl group-hover:text-[#FFD700] transition"></i>`;     
            document.getElementById('deleteEntryBtn').classList.add('hidden');     
            currentPhotoBase64=null;    
            if(!snap.empty && prompt("Limit reached. Admin Pass:")!=="admin123") return showToast("Limit reached", "error");    
            toggleForm();    
        } catch(e){showToast(e.message, 'error')} finally{btn.innerHTML=originalText;}    
    }

    const badWords = ['fish', 'murrel', 'korameenu', 'seed', 'chepa'];    
    document.getElementById('workerForm').addEventListener('submit', async (e) => {    
        e.preventDefault();    
        if(badWords.some(w => document.getElementById('wJob').value.toLowerCase().includes(w))) return showToast("This service is not allowed", "error");    
        const btn = document.getElementById('submitBtn'); btn.innerText="Saving..."; btn.disabled=true;    
        const data = { name:document.getElementById('wName').value, job:document.getElementById('wJob').value, phone:document.getElementById('wPhone').value, area:document.getElementById('wArea').value, bio:document.getElementById('wBio').value, photo:currentPhotoBase64 };    
        try {    
            if(editingId) await updateDoc(doc(db,"workers",editingId), data);    
            else { data.addedByUid=currentUser.uid; data.reviews=[]; data.totalStars=0; data.ratingCount=0; await addDoc(collection(db,"workers"),data); }    
            toggleForm(); closeProfile(); showToast("Details Saved Successfully!");    
        } catch(e){showToast(e.message, 'error')} finally{btn.innerText="Save Details"; btn.disabled=false;}    
    });

    function getIconByJob(job) {    
        const j = (job||'').toLowerCase();    
        if(j.includes('auto')) return {icon:'fa-taxi', color:'bg-yellow-100 text-yellow-600'};    
        if(j.includes('elect')) return {icon:'fa-bolt', color:'bg-blue-100 text-blue-600'};  
        if(j.includes('plum')) return {icon:'fa-wrench', color:'bg-slate-200 text-slate-600'}; 
        return {icon:'fa-briefcase', color:'bg-slate-100 text-slate-500'};    
    }
    
    window.handleEditWorker = (id) => {    
        const w = allWorkers.find(x => x.id === id);    
        editingId = id;    
        document.getElementById('wName').value = w.name;    
        document.getElementById('wJob').value = w.job;    
        document.getElementById('wPhone').value = w.phone;    
        document.getElementById('wBio').value = w.bio || '';    
        document.getElementById('wArea').value = w.area || '';    
        currentPhotoBase64 = w.photo;    
        if(w.photo) document.getElementById('photoPreview').innerHTML = `<img src="${w.photo}" class="w-full h-full object-cover">`;    
        document.getElementById('formTitle').innerText = "Edit Service";    
        document.getElementById('submitBtn').innerText = "Update Details";    
        const delBtn = document.getElementById('deleteEntryBtn'); delBtn.classList.remove('hidden'); delBtn.onclick = () => deleteMyEntry(id);    
        toggleForm();    
    }

    window.deleteMyEntry = async (id) => { if(confirm("Permanently Delete?")) { await deleteDoc(doc(db, "workers", id)); toggleForm(); closeProfile(); showToast("Deleted"); } }    
    window.toggleForm = () => document.getElementById('addForm').classList.toggle('hidden');    
    window.closeProfile = () => { document.getElementById('profileModal').classList.add('hidden'); openProfileId=null; cancelEdit(); }    
    window.filterWorkers = () => { const t = document.getElementById('searchInput').value.toLowerCase(); renderWorkers(allWorkers.filter(w => w.name.toLowerCase().includes(t) || w.job.toLowerCase().includes(t))); }    
</script>
</body>
</html>
