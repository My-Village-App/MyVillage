<!DOCTYPE html>
<html lang="te">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mana Oori Sevalu - Offers</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ramabhadra&family=Inter:wght@400;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
    h1, h2, h3 { font-family: 'Ramabhadra', sans-serif; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 12px 24px; border-radius: 99px; font-size: 14px; opacity: 0; transition: all 0.4s; z-index: 9999; display: flex; align-items: center; gap: 8px; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .fade-scale { animation: fadeScale 0.2s ease-out forwards; }
    @keyframes fadeScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .filter-active { background-color: #dbeafe !important; border-color: #2563eb !important; color: #1d4ed8 !important; }
    .discount-card { border: 1px solid #fcd34d; background: linear-gradient(to bottom right, #ffffff, #fffbeb); }
    .otp-digit { font-variant-numeric: tabular-nums; letter-spacing: 0.2em; }
    .grayscale-card { filter: grayscale(1); opacity: 0.8; border: 1px dashed #94a3b8; }
  </style>
</head>
<body class="text-slate-800 pb-24">

<div id="toast" class="toast"><i class="fas fa-check-circle text-green-400"></i> <span>Message</span></div>

<header class="sticky top-0 bg-white/95 backdrop-blur-md border-b border-slate-200 z-50 shadow-sm">
  <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
    <div class="flex items-center gap-2">
        <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white text-lg shadow-blue-200 shadow-lg"><i class="fas fa-handshake"></i></div>
        <div>
            <h1 class="font-bold text-lg leading-none text-slate-800">‡∞Æ‡∞® ‡∞ä‡∞∞‡∞ø ‡∞∏‡±á‡∞µ‡∞≤‡±Å</h1>
            <p class="text-[10px] text-slate-500 font-bold tracking-widest uppercase">Village Offers</p>
        </div>
    </div>
    <button onclick="handleAuth()" id="authBtn" class="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full text-xs font-bold border border-slate-200">Login</button>
  </div>
</header>

<main class="max-w-md mx-auto p-4 space-y-6">
  <div id="adminPanel" class="hidden bg-red-50 border border-red-200 p-3 rounded-xl mb-4 text-xs text-red-800 flex items-center justify-between">
      <span><i class="fas fa-shield-alt mr-1"></i> <b>Admin Mode</b> Active</span>
  </div>

  <div id="offersSection" class="hidden">
      <div class="flex items-center justify-between mb-2 px-1">
          <h2 class="text-base font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-gift text-pink-500 animate-bounce"></i> Offers Near You</h2>
          <button onclick="toggleDiscountFilter(true)" class="text-xs text-blue-600 font-bold">View All</button>
      </div>
      <div id="offersList" class="flex gap-3 overflow-x-auto pb-4 snap-x hide-scrollbar" style="scrollbar-width: none;"></div>
  </div>

  <div class="sticky top-[68px] z-40 bg-[#f1f5f9] -mx-4 px-4 pb-2 pt-1">
      <div class="flex gap-2">
          <div class="relative flex-1 shadow-sm">
            <i class="fas fa-search absolute left-3 top-3.5 text-slate-400"></i>
            <input id="searchInput" class="w-full pl-10 pr-3 py-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-medium text-sm" placeholder="Search (e.g. Mechanic)..." />
          </div>
          <button id="discountFilterBtn" onclick="toggleDiscountFilter()" class="bg-white border border-slate-200 text-slate-500 px-3 rounded-xl shadow-sm font-bold text-xs flex flex-col items-center justify-center min-w-[60px] active:scale-95 transition">
              <i class="fas fa-percent text-sm mb-0.5"></i>
              <span>Offers</span>
          </button>
      </div>
  </div>

  <div id="mainList" class="space-y-4">
      <div class="animate-pulse space-y-4">
          <div class="h-32 bg-slate-200 rounded-2xl"></div>
          <div class="h-32 bg-slate-200 rounded-2xl"></div>
      </div>
  </div>

  <button onclick="openAddModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl shadow-blue-400 flex items-center justify-center text-2xl z-40 active:scale-90 transition border-4 border-slate-100">
      <i class="fas fa-plus"></i>
  </button>
</main>

<!-- OTP MODAL -->
<div id="otpModal" class="hidden fixed inset-0 bg-slate-900/90 z-[60] flex items-center justify-center p-6 fade-scale backdrop-blur-md">
    <div class="bg-white w-full max-w-sm rounded-3xl p-6 text-center relative overflow-hidden shadow-2xl border-4 border-blue-100">
        <button onclick="closeOtp()" class="absolute top-4 right-4 w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i class="fas fa-times"></i></button>
        <div class="flex flex-col items-center mb-6 border-b border-slate-100 pb-4">
             <div class="bg-blue-600 text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-2 shadow-md">Official Code</div>
             <h3 class="text-xl font-bold text-slate-800">Mana Oori Sevalu</h3>
        </div>
        <div class="mb-2">
            <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Discount Coupon For</p>
            <h2 id="otpShopName" class="text-lg font-bold text-blue-900 mt-1 leading-tight">Shop Name</h2>
        </div>
        <div class="my-6 relative">
            <div id="otpDisplay" class="bg-slate-50 text-slate-800 text-5xl font-mono font-bold py-6 rounded-2xl border-2 border-dashed border-slate-300 tracking-[0.3em] shadow-inner relative z-10 otp-digit">----</div>
            <div class="absolute -top-3 -right-3 bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-lg border-2 border-white z-20"><i class="fas fa-check"></i></div>
        </div>
        <div class="flex items-center justify-center gap-2 text-xs font-mono text-red-500 bg-red-50 py-2 rounded-lg mb-4">
            <i class="far fa-clock"></i> Expires in <span id="timer" class="font-bold">05:00</span>
        </div>
        <p class="text-[10px] text-slate-400 leading-relaxed px-4">Show this to the shopkeeper.</p>
    </div>
</div>

<!-- ADD MODAL -->
<div id="addModal" class="hidden fixed inset-0 bg-slate-900/60 z-[60] flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
    <div class="bg-white w-full sm:max-w-md h-[85vh] sm:h-auto sm:rounded-3xl rounded-t-3xl p-6 relative flex flex-col shadow-2xl">
        <button onclick="document.getElementById('addModal').classList.add('hidden')" class="absolute top-4 right-4 w-8 h-8 bg-slate-100 rounded-full"><i class="fas fa-times"></i></button>
        <h2 class="text-xl font-bold mb-4">Add Service</h2>
        <p class="text-xs text-slate-500 mb-4 bg-yellow-50 p-2 rounded border border-yellow-100"><i class="fas fa-shield-alt"></i> Listings require Admin verification.</p>
        <form id="addForm" class="space-y-4 overflow-y-auto flex-1 pb-10">
            <input id="iName" class="w-full p-3 bg-slate-50 border rounded-xl font-bold" placeholder="Shop/Person Name" required>
            <input id="iJob" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="Category (e.g. Mechanic)" required>
            <input id="iArea" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="Area / Village" required>
            <input id="iPhone" type="tel" class="w-full p-3 bg-slate-50 border rounded-xl font-bold tracking-widest" placeholder="Phone Number" required>
            <div class="border border-blue-100 bg-blue-50 p-4 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <label class="font-bold text-blue-900 text-sm flex items-center gap-2"><i class="fas fa-tags"></i> Enable Offer?</label>
                    <input type="checkbox" id="iHasDiscount" class="w-5 h-5 accent-blue-600" onchange="toggleOfferInput(this)">
                </div>
                <div id="offerInputBox" class="hidden">
                    <input id="iOfferText" class="w-full p-2 text-sm border border-blue-200 rounded-lg" placeholder="Ex: 10% Off for villagers">
                </div>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-blue-200">Submit</button>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs, limit, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const ADMIN_EMAIL = "yesebubirudugadda37@gmail.com"; 

    const firebaseConfig = {
      apiKey: "AIzaSyBfonEUIssxYV5BFxOEsTIA9alYzISEOGU",
      authDomain: "myvillage-app-c3550.firebaseapp.com",
      projectId: "myvillage-app-c3550",
      storageBucket: "myvillage-app-c3550.firebasestorage.app",
      messagingSenderId: "1081682544474",
      appId: "1:1081682544474:web:c844c928e69915013b1563"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let allServices = [], currentUser = null, filterDiscountOnly = false;
    let isAdmin = false;

    window.handleAuth = () => { 
        if(!currentUser) signInWithPopup(auth, new GoogleAuthProvider()); 
        else if(confirm("Do you want to logout?")) signOut(auth);
    }
    
    onAuthStateChanged(auth, u => {
        currentUser = u;
        if(u) {
            isAdmin = (u.email === ADMIN_EMAIL);
            document.getElementById('authBtn').innerHTML = `<img src="${u.photoURL}" class="w-6 h-6 rounded-full border border-slate-300">`;
            if(isAdmin) document.getElementById('adminPanel').classList.remove('hidden');
        } else {
            isAdmin = false;
            document.getElementById('authBtn').innerHTML = "Login";
            document.getElementById('adminPanel').classList.add('hidden');
        }
        renderApp();
    });

    const q = query(collection(db, "workers"), orderBy("name"));
    onSnapshot(q, (snap) => {
        allServices = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderApp();
    });

    function renderApp() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allServices.filter(s => {
            const matchesSearch = s.name.toLowerCase().includes(term) || s.job.toLowerCase().includes(term);
            const matchesDiscount = filterDiscountOnly ? (s.hasDiscount === true) : true;
            const isVerified = (s.verified === true) || (s.verified === undefined);
            const isVisible = isVerified || isAdmin;
            return matchesSearch && matchesDiscount && isVisible;
        });

        const offers = allServices.filter(s => s.hasDiscount && ((s.verified === true || s.verified === undefined) || isAdmin));
        const offersSec = document.getElementById('offersSection');
        if(offers.length > 0 && !term && !filterDiscountOnly) {
            offersSec.classList.remove('hidden');
            document.getElementById('offersList').innerHTML = offers.map(s => `
                <div class="min-w-[260px] bg-slate-900 p-4 rounded-2xl text-white shadow-lg relative snap-center">
                    <div class="absolute top-0 right-0 bg-yellow-400 text-black text-[10px] font-bold px-2 py-1 rounded-bl-xl rounded-tr-xl">OFFER</div>
                    <h3 class="font-bold text-lg truncate">${s.name}</h3>
                    <p class="text-slate-300 text-xs mb-3">${s.offerText || 'Discount available'}</p>
                    <button onclick="generateOTP('${s.id}', '${s.name}')" class="w-full bg-white text-slate-900 font-bold py-2 rounded-lg text-xs hover:bg-slate-100">Get Code</button>
                </div>
            `).join('');
        } else {
            offersSec.classList.add('hidden');
        }

        const list = document.getElementById('mainList');
        if(filtered.length === 0) { list.innerHTML = `<div class="text-center py-10 text-slate-400">No services found</div>`; return; }

        list.innerHTML = filtered.map(s => {
            const isVerified = (s.verified === true) || (s.verified === undefined);
            
            // ADMIN DELETE BUTTON
            let adminActions = '';
            let deleteBtn = '';
            if(isAdmin) {
                // Delete button for ALL cards if admin
                deleteBtn = `<button onclick="deleteWorker('${s.id}')" class="absolute top-2 left-2 w-8 h-8 bg-white/90 text-red-600 rounded-full shadow-lg z-20 flex items-center justify-center hover:bg-red-50"><i class="fas fa-trash-alt"></i></button>`;
                
                if(!isVerified) {
                    adminActions = `
                    <div class="bg-red-50 border border-red-100 p-2 rounded-lg mt-2 flex justify-between items-center">
                        <span class="text-xs text-red-600 font-bold"><i class="fas fa-lock"></i> Pending</span>
                        <button onclick="approveWorker('${s.id}')" class="bg-green-600 text-white text-xs px-3 py-1.5 rounded-lg font-bold shadow-md hover:bg-green-700">Approve</button>
                    </div>`;
                }
            }

            const badge = s.hasDiscount ? `<div class="absolute -top-3 -right-2 bg-yellow-400 text-slate-900 text-[10px] px-2 py-1 rounded shadow-md font-bold border border-white z-10">OFFER</div>` : '';
            const actionBtn = s.hasDiscount
                ? `<button onclick="generateOTP('${s.id}', '${s.name}')" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-slate-200 active:scale-95 transition">Get Discount Code</button>`
                : `<a href="tel:${s.phone}" class="flex-1 bg-blue-50 text-blue-700 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 border border-blue-100"><i class="fas fa-phone"></i> Call Now</a>`;

            return `
            <div class="relative ${s.hasDiscount ? 'discount-card shadow-md' : 'bg-white border-slate-100 shadow-sm'} ${!isVerified ? 'grayscale-card' : ''} p-4 rounded-2xl border flex flex-col gap-3">
                ${badge}
                ${deleteBtn}
                <div class="flex gap-4 items-center">
                    <div class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center text-xl text-slate-400 shrink-0"><i class="fas fa-store"></i></div>
                    <div class="min-w-0">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight truncate">${s.name}</h3>
                        <p class="text-xs text-slate-500 uppercase tracking-wide font-bold">${s.job} ‚Ä¢ ${s.area}</p>
                    </div>
                </div>
                ${isVerified ? `<div class="flex gap-2 mt-1">${actionBtn}</div>` : adminActions}
            </div>`;
        }).join('');
    }

    // --- ADMIN FUNCTIONS ---
    window.approveWorker = async (id) => {
        if(!isAdmin) return;
        if(confirm("Verify: Approve this listing?")) {
            await updateDoc(doc(db, "workers", id), { verified: true });
            toast("‚úÖ Approved!");
        }
    }

    window.deleteWorker = async (id) => {
        if(!isAdmin) return;
        if(confirm("‚ö† ALERT: Delete this offer permanently? This cannot be undone.")) {
            await deleteDoc(doc(db, "workers", id));
            toast("üóë Deleted!");
        }
    }

    window.toggleDiscountFilter = (forceTrue) => {
        filterDiscountOnly = forceTrue ? true : !filterDiscountOnly;
        document.getElementById('discountFilterBtn').classList.toggle('filter-active', filterDiscountOnly);
        renderApp();
    }
    document.getElementById('searchInput').addEventListener('input', renderApp);

    window.generateOTP = async (shopId, shopName) => {
        if(!currentUser) { toast("Please Login to get Offers"); handleAuth(); return; }
        const btn = document.activeElement; if(btn) btn.innerText = "Checking...";
        try {
            const q = query(collection(db, "otpCodes"), where("userId", "==", currentUser.uid), where("shopId", "==", shopId), where("status", "==", "active"), limit(1));
            const snap = await getDocs(q);
            let code, createdTime;
            if (!snap.empty) {
                const data = snap.docs[0].data(); code = data.code; createdTime = data.timestamp ? data.timestamp.toMillis() : Date.now();
            } else {
                code = Math.floor(1000 + Math.random() * 9000).toString(); createdTime = Date.now();
                await addDoc(collection(db, "otpCodes"), { 
                    code: code, 
                    shopId: shopId, 
                    shopName: shopName, // SAVING SHOP NAME HERE
                    userId: currentUser.uid, 
                    userName: currentUser.displayName, 
                    timestamp: serverTimestamp(), 
                    status: 'active' 
                });
            }
            document.getElementById('otpShopName').innerText = shopName; document.getElementById('otpDisplay').innerText = code; document.getElementById('otpModal').classList.remove('hidden');
            const timePassed = Date.now() - createdTime; let timeLeft = Math.max(0, Math.floor((300000 - timePassed) / 1000));
            if(window.otpTimer) clearInterval(window.otpTimer);
            const timerEl = document.getElementById('timer');
            window.otpTimer = setInterval(() => { timeLeft--; if(timeLeft < 0) { clearInterval(window.otpTimer); timerEl.innerText = "Expired"; closeOtp(); return; } const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; timerEl.innerText = `0${m}:${s < 10 ? '0'+s : s}`; }, 1000);
        } catch(e) { console.error(e); toast("Error generating code"); } finally { if(btn) btn.innerText = "Get Discount Code"; }
    }

    window.closeOtp = () => document.getElementById('otpModal').classList.add('hidden');
    window.openAddModal = () => currentUser ? document.getElementById('addModal').classList.remove('hidden') : (toast("Login Required"), handleAuth());
    window.toggleOfferInput = (cb) => document.getElementById('offerInputBox').classList.toggle('hidden', !cb.checked);

    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button'); btn.disabled=true; btn.innerText="Submitting...";
        await addDoc(collection(db, "workers"), {
            name: document.getElementById('iName').value, job: document.getElementById('iJob').value,
            area: document.getElementById('iArea').value, phone: document.getElementById('iPhone').value,
            hasDiscount: document.getElementById('iHasDiscount').checked, offerText: document.getElementById('iOfferText').value,
            addedBy: currentUser.uid, createdAt: serverTimestamp(), verified: false
        });
        document.getElementById('addModal').classList.add('hidden'); e.target.reset(); btn.disabled=false; btn.innerText="Submit";
        alert("Submitted for Admin Verification.");
    });
    window.toast = (msg) => { const t = document.getElementById('toast'); t.querySelector('span').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
</script>
</body>
              </html>
